{% extends 'dashboard/main.html' %}

{% block content %}
{% load static %}
<div class="main-content">
  <section class="section">
    <div class="section-body">
      <div class="row">
        <div class="col-12">
          <div class="card">
            <div class="card-header">
              <h4>Edit Product - {{ product.taitle }}</h4>
            </div>
            <div class="card-body">
              <form method="post" enctype="multipart/form-data">
                {% csrf_token %}
                
                <!-- Current Images Section -->
                <div class="form-group">
                  <label>Current Images</label>
                  <div class="d-flex flex-wrap">
                    {% for image in product_images %}
                    <div class="position-relative mr-3 mb-3">
                      <img src="{{ image.image.url }}" alt="Product image" class="rounded" style="height: 150px; width: 150px; object-fit: cover;">
                      <div class="position-absolute" style="top: 5px; right: 5px;">
                        <span class="badge badge-{% if image.is_main %}success{% else %}info{% endif %}">
                          {% if image.is_main %}Main Image{% else %}Image {{ forloop.counter }}{% endif %}
                        </span>
                      </div>
                      <div class="text-center mt-2">
                        <form method="post" action="{% url 'delete_product_image' image.id %}">
                          {% csrf_token %}
                          <button type="submit" class="btn btn-danger btn-sm" onclick="return confirm('Are you sure you want to delete this image?')">
                            Delete
                          </button>
                        </form>
                      </div>
                    </div>
                    {% endfor %}
                  </div>
                </div>

                <!-- Add New Images Section -->
                <div class="form-group">
                  <label>Add New Images (Maximum {{ 5|add:"-"|add:product_images.count }} remaining)</label>
                  <div class="custom-file">
                    {{ form.images }}
                    <label class="custom-file-label" for="id_images">Choose files...</label>
                  </div>
                  <small class="form-text text-muted">You can add up to {{ 5|add:"-"|add:product_images.count }} more images.</small>
                  <div id="imagePreview" class="mt-2 d-flex flex-wrap">
                  </div>
                </div>

                <div class="form-group">
                  <label>Title</label>
                  {{ form.taitle }}
                </div>
                <div class="form-group">
                  <label>Category</label>
                  {{ form.catagory }}
                </div>
                <div class="form-group">
                  <label>Price</label>
                  {{ form.price }}
                </div>
                <div class="form-group">
                  <label>Was Price</label>
                  {{ form.WasPrice }}
                </div>
                <div class="form-group">
                  <label>Delivery Price</label>
                  {{ form.DeleveryPrice }}
                </div>
                <div class="form-check mb-3">
                  <label>{{ form.size }} Has Size Options</label>
                </div>
                <div class="form-group">
                  <label>Description</label>
                  <div id="editor-description">{{ product.dicription|safe }}</div>
                  <input type="hidden" name="dicription" id="description-input">
                </div>
                <div class="form-group">
                  <label>Product Highlight</label>
                  <div id="editor-info">{{ product.info|safe }}</div>
                  <input type="hidden" name="info" id="info-input">
                </div>
                <button type="submit" class="btn btn-primary">Update Product</button>
                <a href="{% url 'products' %}" class="btn btn-secondary">Cancel</a>
              </form>
            </div>
          </div>
        </div>
      </div>
    </div>
  </section>
</div>

<link href="https://cdn.jsdelivr.net/npm/quill@2.0.3/dist/quill.snow.css" rel="stylesheet" />
<script src="https://cdn.jsdelivr.net/npm/quill@2.0.3/dist/quill.js"></script>

<script>
  // Initialize Quill editors
  const quillDescription = new Quill('#editor-description', {
    theme: 'snow'
  });

  const quillInfo = new Quill('#editor-info', {
    theme: 'snow'
  });

  // Handle form submission
  document.querySelector('form').addEventListener('submit', function(e) {
    const descriptionContent = quillDescription.root.innerHTML;
    document.querySelector('#description-input').value = descriptionContent;

    const infoContent = quillInfo.root.innerHTML;
    document.querySelector('#info-input').value = infoContent;
  });

  // Handle multiple image preview
  document.querySelector('#id_images').addEventListener('change', function(e) {
    const preview = document.querySelector('#imagePreview');
    preview.innerHTML = '';
    
    const maxNewImages = 5 - {{ product_images.count }};
    if (this.files.length > maxNewImages) {
      alert(`You can only add up to ${maxNewImages} more images`);
      this.value = '';
      return;
    }

    Array.from(this.files).forEach((file, index) => {
      if (file) {
        const reader = new FileReader();
        reader.onload = function(e) {
          const div = document.createElement('div');
          div.className = 'mr-2 mb-2 position-relative';
          div.innerHTML = `
            <img src="${e.target.result}" class="rounded" style="height: 100px; width: 100px; object-fit: cover;">
            <span class="badge badge-info position-absolute" style="top: 5px; right: 5px;">
              New Image ${index + 1}
            </span>
          `;
          preview.appendChild(div);
        }
        reader.readAsDataURL(file);
      }
    });

    // Update file input label
    const label = document.querySelector('.custom-file-label');
    label.textContent = this.files.length > 1 ? `${this.files.length} files selected` : this.files[0].name;
  });
</script>
{% endblock %}